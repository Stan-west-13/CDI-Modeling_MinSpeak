---
title: "Standardized Network Analysis"
author: "Stanley West"
format: 
  revealjs:
    embed-resources: true
    self-contained-math: true
    scrollable: true
    smaller: true
    fig-width: 24
    fig-height: 12
    fig-align: center
    
    
editor: 
  markdown: 
    wrap: 72
---

# The Data {.smaller .scrollable}

-   Up to this point, individual lexical networks have been constructed
    for each child, with edges drawn according to forward association
    (i.e., cue -\> response) relationships via child-oriented word
    association norms ([Cox & Haebig,
    2023](https://link.springer.com/content/pdf/10.3758/s13428-022-01790-y.pdf))
    -   Network statistics including in-degree (number of incoming
        connections), global clustering coefficient (ratio of number of
        triangles to the number of possible triangles), mean average
        shortest path length (ASPL, average edge distance between nodes)
        were computed for each child.
-   These values were standardized according to 1,000 individualized
    pseudo-random acquisition networks for each child where the number
    of nodes as well as the number of nouns, verbs, and other words were
    matched to the child's vocabulary.

```{r,echo = FALSE}
library(tidyverse)
library(ggplot2)
library(purrr)
library(MatchIt)
library(ggh4x)
library(plotly)
library(ggraph)
d_netstats <- read_rds("data/all_Netstats_z_meta.rds") %>%
  mutate(metric_plot = factor(metric, 
                              levels = c("indegreemed","indegreeavg","clustcoef","meandist"),
                              labels = c("Median_Indegree", "Average_Indegree","Clustering_Coefficient","Mean Distance")),
         group = factor(group, levels = c("yng", "mdl", "old")),
         netBuild = "associations")

d_netstats_nouns <- read_rds("data/all_Netstats_z_meta_nouns.rds")%>%
  mutate(metric_plot = factor(metric, 
                              levels = c("indegreemed","indegreeavg","clustcoef","meandist"),
                              labels = c("Median_Indegree", "Average_Indegree","Clustering_Coefficient","Mean Distance")),
         group = factor(group, levels = c("yng", "mdl", "old")),
         netBuild = "nounFeats")
d_netstats <- rbind(d_netstats,d_netstats_nouns) %>%
  mutate(netBuild = as.factor(netBuild),
         metric = as.factor(metric),
         stat = as.factor(stat))
matched_pps <- read_rds("data/matched_groups_single_timepoint.rds")

load("data/graph_full_nounNet.Rdata")
load("data/child_oriented_graph.Rdata")

```

## Overall Statistic Trajectories Over Vocabulary Size and Age {.smaller .scrollable}

```{r}

ggplot(d_netstats %>% 
         filter(origin == "truenet"& stat == "truestat"), aes(x = nProduced, y = value))+
  geom_point()+
  geom_smooth(method = "loess")+
  facet_grid2(netBuild~metric_plot,scales = "free", independent = "all")+
  theme_bw(base_size = 24)+
  labs(title = "True Scores Across Vocabuary")

ggplot(d_netstats %>% 
         filter(origin == "RAN"& stat == "mean"), aes(x = nProduced, y = value))+
  geom_point()+
  geom_smooth(method = "loess")+
  facet_grid2(netBuild~metric_plot,scales = "free", independent = "all")+
  theme_bw(base_size = 24)+
  labs(title = "RAN Mean Scores Across Vocabuary")

ggplot(d_netstats %>% 
         filter(origin == "RAN"& stat == "sd"), aes(x = nProduced, y = value))+
  geom_point()+
  geom_smooth(method = "loess")+
  facet_grid2(netBuild~metric_plot,scales = "free", independent = "all")+
  theme_bw(base_size = 24)+
  labs(title = "RAN SD Scores Across Vocabuary")


ggplot(d_netstats, aes(x = nProduced, y = z))+
  geom_point()+
  geom_smooth(method = "loess")+
  facet_grid2(netBuild~metric_plot,scales = "free",independent = "all")+
  theme_bw(base_size = 24)+
  labs(title = "Standardized Scores across vocabuary")


ggplot(d_netstats %>%
         group_by(subjectkey_intAge,metric,netBuild) %>%
         mutate(RAN_dist = (value[stat == "truestat"] - value[stat =="mean"])), aes(x = nProduced,y = RAN_dist, fill = netBuild))+
  geom_col(position = "dodge")+
  facet_wrap2(~metric_plot,scales = "free")+
  theme_bw(base_size = 24)+
  labs(y = "true stat - mean RAN stat")

ggsave("Figures/RAN_distance_plot.png")


ggplot(d_netstats, aes(x = nProduced, y = value, color = stat))+
  geom_point()+
  geom_smooth()+
  facet_grid2(netBuild~metric_plot, scales = "free", independent = "all")
ggsave("Figures/network_stats_comparison.png")


```

## Plotting unmatched statistic distributions over production {.smaller .scrollable}

-   Distributions across the unmatched samples look similar, especially
    at smaller vocabularies.
-   However, this is still collapsed across forms.

```{r}

ggplot(d_netstats %>% 
         filter(form == "WS"), aes(x = nProduced, y = z, color = group))+
  facet_grid2(netBuild~metric_plot,scales = "free",independent = "all")+
  geom_smooth(method = "lm",
              formula = y~poly(x,3))+
  theme_bw(base_size = 24)+
  labs(title = "Unmatched Statistic Distrubution Over Production - Words & Sentences",
       x = "Productive Vocabulary",
       y = "Z-scored Network Statistic")

ggplot(d_netstats %>% 
         filter(form == "WG"), aes(x = nProduced, y = z, color = group))+
  geom_point() +
  facet_grid2(netBuild~metric_plot,scales = "free",independent = "all")+
  geom_smooth(method = "lm",
              formula = y~poly(x,3))+
  theme_bw(base_size = 24)+
  labs(title = "Unmatched Statistic Distrubution Over Production - Words & Gestures",
       x = "Productive Vocabulary",
       y = "Z-scored Network Statistic")



ggplot(d_netstats , aes(x = group, y = z, color = group))+
  geom_violin() +
  geom_boxplot(width = 0.2, fill = "lightgrey")+
  facet_grid2(netBuild~metric_plot,scales = "free",independent = "all")+
  theme_bw(base_size = 24)+
  labs(title = "Unmatched Statistic Boxplots Over Group ",
       x = "Group",
       y = "Z-scored Network Statistic")

```

-   The middle group does not have any child with production past 100
    for the words and gestures form, making it hard to compare to the
    other groups, so we collapsed this group with the youngest group and
    instead will look at delayed vs. non-delayed vocabularies.

## First Administrations - Both Forms

-   Including both WS and WG, but only taking the first administration
    for a child results in 222 words and sentences and 48 words and
    gestures forms.

```{r}
d_netstats_first <- d_netstats %>%
  mutate(group_two = as.factor(ifelse(group == "yng"|group =="mdl", "no_delay","delay"))) %>%
  filter(origin == "truenet") %>%
  group_by(subjectkey) %>%
  slice_min(interview_age, n = 1 )

d_netstats_first %>%
  select(subjectkey,group_two,nProduced, interview_age,netBuild) %>%
  unique() %>%
  group_by(group_two,netBuild) %>%
  summarize(n = n(),
            mean_nProduced = mean(nProduced),
            sd_nProduced = sd(nProduced),
            mean_age = mean(interview_age),
            sd_age = sd(interview_age)) %>%
  as.data.frame()




```

## Matching to the minimally speaking group.

-   Welch two sample t-test revealed no significant difference in
    productive vocabulary between groups for either the association,
    $t(80.84) = -0.243, p = 0.809$ or noun-feature,
    $t(79.14) = -0.255, p = 0.799$ constructed networks.

```{r}

noun_assoc_split <- split(d_netstats_first,d_netstats_first$netBuild)


match_noun_assoc <- map(noun_assoc_split, function(x){
  matchit_all <- x %>%
    select(subjectkey_intAge, interview_age,nProduced, group_two) %>%
    unique() %>%
    matchit(group_two ~ nProduced, data = ., method = "optimal", distance = "glm"  ,ratio = 3)
  match_df <- x %>%
     filter(subjectkey_intAge %in% match.data(matchit_all)$subjectkey_intAge) %>%
     mutate(int_age_cut = cut(interview_age,3))
  return(match_df)
})

map(match_noun_assoc, function(x){
  x %>%
    select(subjectkey,nProduced,group_two) %>%
    unique() %>%
    t.test(nProduced~group_two, data = .)
})


```

-   Keeping both WS and WG forms, we match the no-delay group to the 48
    delayed children, allowing the no-delay group to be 3x bigger.

```{r, echo =  FALSE,fig.width=48, fig.height=12, fig.fullwidth=TRUE}

map(match_noun_assoc, function(x){
  x %>%
    select(subjectkey,interview_age,nProduced,group_two) %>%
    unique() %>%
    group_by(group_two) %>%
    summarize(n = n(),
              mean_age = mean(interview_age),
              mean_produced = mean(nProduced),
              sd_age = sd(interview_age),
              sd_produced = sd(nProduced)) %>%
    as.data.frame()
})

map(match_noun_assoc, ~
        ggplot(.x, aes(x = nProduced, color = group_two))+
          geom_density(size = 2)+
          theme_bw(base_size = 52)+
          labs(title = paste0("Matching between groups ", unique(.x$netBuild))))

map(match_noun_assoc, ~
        ggplot(.x, aes(x = nProduced, , y = interview_age,color = group_two))+
          geom_point(size = 13)+
          theme_bw(base_size = 52)+
          labs(title = paste0("Matching between groups ", unique(.x$netBuild))))


```

## Run Linear Models {.smaller .scrollable}

-   Number of words produced was re-factored to account for third-order
    polynomial trends in the network statistics

-   Linear models were run regressing
    $network_{statistic} \sim (linear_{nproduced} + quadratic_{nproduced} +cubic_{nproduced})  * group$

-   Associations:

    -   Each model except for the clustering coefficient model revealed
        linear, quadratic, and cubic trends in number of words produced.

    -   There is also an linear by group interaction for clustering
        coefficient where it appears that the no delay children are more
        linear in network cluster growth especially at large vocabulary
        sizes.

-   Noun Features:

    -   Each metric revealed group main effects where the delayed group
        exhibits higher degree networks with more clustering and shorter
        distance between nodes than the non-delayed group.

    -   The only interaction was in the median indegree analysis where
        the was a group by linear trend interaction where the delayed
        group appears to have a more linear increase in median degree
        than the non-delay group.

-   Looking at associative versus noun-feature networks result in
    conflicting conclusions about the structure of early delayed versus
    non-delayed vocabularies.

```{r}

nProduced_poly_all <- match_noun_assoc %>%
  map(~ .x %>%
        ungroup() %>%
        select(nProduced) %>%
        unique() %>%
        cbind(poly(.$nProduced,3)) %>%
        rename(linear = "1",
               quadratic = "2",
               cubic = "3"))

matched_df_poly_all <- map2(match_noun_assoc,nProduced_poly_all, function(x,y){
                              x %>%
                              left_join(y) %>%
                              filter(origin == "truenet")
}) 
 
d_splits_all <- matched_df_poly_all %>%
  map(~ split(.x,.x$metric))

x <- map(d_splits_all, function(x){
    map(x, function(d){ 
          lm(z ~ (linear+quadratic+cubic)*group_two, data = d)
      })
})

map(x, ~map(.x, function(d){summary(d)}))


```

## Plot the Trends

```{r}

map(matched_df_poly_all, ~ ggplot(.x %>% 
         filter(origin == "truenet"), aes(x = nProduced, y = z, color = group_two))+
  #geom_point()+
  theme_bw(base_size = 24) +
  geom_smooth(method = "lm",
              formula = y ~ poly(x,3))+
  facet_grid(~metric_plot)+
  labs(title = "Network Statistic Trajectory by Group",
       subtitle = paste("Network Construction:",unique(.x$netBuild))))




```

# Words and Gestures Analyses Only

-   Youngest administration

-   Only allowing networks of size 3 - 349 words

-   Collapsing the middle-aged group (48 - 70 months old) and the
    youngest group (16 - 42 months) to create delayed and non-delayed
    language groups.

## Filtering to Words and Gestures

```{r,echo = TRUE}
d_WG <- d_netstats %>%
  filter(form == "WG",
         nProduced >= 3 & nProduced <= 392) %>%
  group_by(subjectkey) %>%
  slice_min(interview_age,n = 1) %>%
  mutate(group_two = as.factor(ifelse(group == "yng"|group =="mdl", "no_delay","delay")))

d_WG %>%
  select(subjectkey,interview_age,nProduced,group_two,netBuild) %>%
  unique() %>%
  group_by(group_two,netBuild) %>%
  summarize(n = n(),
            mean_age = mean(interview_age),
            mean_produced = mean(nProduced),
            sd_age = sd(interview_age),
            sd_produced = sd(nProduced)) %>%
  as.data.frame()
  


```

## Match groups on vocabulary size {.scrollable .smaller}

-   Matching to the delayed group, but allowing for the non-delay group
    to be twice as big.
-   Production matching
    -   Associations: $t(59.58) = -0.844, p = 0.402$
    -   Noun features: $t(56.44) = -0.831, p = 0.402$

```{r, echo =  FALSE,fig.fullwidth=TRUE,fig.width=24, fig.height=12}

WG_split_noun_assoc <- split(d_WG, d_WG$netBuild)


matched_df <- map(WG_split_noun_assoc, function(x){
  match_lst <- x %>%
         select(subjectkey_intAge, interview_age,nProduced, group_two) %>%
         unique() %>%
         matchit(group_two ~ nProduced, data = ., method = "optimal", distance = "glm", ratio = 2)
  matched_df <- x %>%
        filter(subjectkey_intAge %in% match.data(match_lst)$subjectkey_intAge)
  return(matched_df)
})




matched_df %>%
  map(~.x %>%
        select(subjectkey,nProduced,group_two) %>%
        unique() %>%
        t.test(nProduced~group_two, data = .))
  





```

```{r, echo =  FALSE,fig.width=48, fig.height=12, fig.fullwidth=TRUE}

map(matched_df, ~
                .x %>%   
                  select(subjectkey_intAge,group_two,interview_age,nProduced) %>%
                  unique() %>%
                  group_by(group_two) %>%
                  summarize(n = n(),
                            mean_age = mean(interview_age),
                            sd_age = sd(interview_age),
                            mean_nProduced = mean(nProduced),
                            sd_nProduced = sd(nProduced)))

map(matched_df, ~
        ggplot(.x, aes(x = nProduced, color = group_two))+
            geom_density(size = 2)+
            theme_bw(base_size = 52)+
            labs(title = paste0("Matching between groups ", unique(.x$netBuild))))
map(matched_df, ~
        ggplot(.x, aes(x = nProduced, , y = interview_age,color = group_two))+
            geom_point(size = 13)+
            theme_bw(base_size = 52)+
            labs(title = paste0("Matching between groups ", unique(.x$netBuild))))          
```

## Run Linear Models

-   Number of words produced was re-factored to account for third-order
    polynomial trends in the network statistics

-   Linear models were run regressing
    $network_{statistic} \sim (linear_{nproduced} + quadratic_{nproduced} +cubic_{nproduced}) * group$

-   Associations:

    -   Group difference only in median indegree, where the delay group
        seems to have higher indegree networks compared to the no-delay
        group. There were no interactions with linear, quadratic, or
        cubic vocabulary production trends.

-   Noun Feature:

    -   Each model except for ASPL revealed a significant effect of
        group, where the delay group exhibits more clustered and higher
        degree network structure.

    -   There is an interaction of group and linear production trends
        for the clustering coefficient and ASPL, where again the delay
        group appears more linear.

```{r}
nProduced_poly <- matched_df %>%
  map(~.x %>% 
         ungroup() %>%
         select(nProduced) %>%
         unique() %>%
         cbind(poly(.$nProduced,3)) %>%
         rename(linear = "1",
               quadratic = "2",
               cubic = "3"))
 

matched_df_poly <- map2(matched_df,nProduced_poly, function(x,y){
  return(x %>%
           left_join(y) %>%
           filter(origin == "truenet"))
}) 
  

d_splits <- map(matched_df_poly, function(x){
  split(x,x$metric)
})

x_WG <- map(d_splits, function(x){
  map(x,~lm(z ~ (linear+quadratic+cubic) * group_two, data = .x))
})

map(x_WG,~ map( .x,~summary(.x)))
```

```{r}

map(matched_df_poly, ~ 
      ggplot(.x %>% 
         filter(origin == "truenet"), aes(x = nProduced, y = z, color = group_two))+
  #geom_point()+
  theme_bw(base_size = 24) +
  geom_smooth(method = "lm",
              formula = y ~ poly(x,3))+
  facet_wrap(~metric_plot)+
  labs(title = "Network Statistic Trajectory by Group",
       subtitle = paste("Network Construction:",unique(.x$netBuild)))
)
```

# Conclusion

## Association Networks

-   Using both words and gestures and words and sentences forms in the
    models allows for 144 no-delay and 48 delayed children to be
    included.

    -   We found that there was an interaction of group and linear
        production trends for clustering coefficient where the delay
        group exhibits less linear clustering at larger vocabulary sizes
        (after \~ 500 words)

-   Using just the words and gestures allows for 70 no-delay and 35
    delayed children to be included.

    -   The only group difference found was in median indegree, where
        the delay group has higher indegree networks than the no-delay
        group and there were no interactions with word production
        trends.

## Noun Feature Networks

-   Using both words and gestures and words and sentences forms in the
    models allows for 144 no-delay and 48 delayed children to be
    included.

    -   Each metric revealed group main effects where the delayed group
        shows higher degree networks that are more clustered and shorter
        ASPL than the non-delayed group.

    -   Only interaction was in median indegree where the delayed group
        shows more pronounced linear trends in degree across
        development.

-   Using just words and gestures allows 64 non-delay and 32 delayed
    children to be included.

    -   Each model except ASPL revealed a significant effect of group,
        where the delay group exhibits more clustered networks with
        higher indegree.

    -   There is an interaction of group and linear production trends
        for the clustering coefficient and ASPL, where again the delay
        group appears more linear.
